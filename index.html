<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Burger Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root { --gap: 1rem; }
    body { padding: 24px; }
    .monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .card { border-radius: 16px; }
    .table td, .table th { vertical-align: middle; }
    .cursor { cursor: pointer; }
    @media (max-width: 576px) {
      .stack-sm { display: grid; gap: var(--gap); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="mb-3">
      <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-end gap-2">
        <div>
          <h1 class="mb-1">Burger Web</h1>
          <p class="text-muted mb-0">Frontend didático, 1 arquivo, integrado ao seu back C# (.NET 8 + Swagger).</p>
        </div>

        <!-- Seletor de ambiente -->
        <div class="card">
          <div class="card-body py-2 px-3">
            <div class="row g-2 align-items-center">
              <div class="col-auto"><strong>Ambiente:</strong></div>
              <div class="col">
                <select id="envSelect" class="form-select form-select-sm">
                  <!-- Valores padrão; ajuste a URL do Railway abaixo, se necessário -->
                  <option value="https://swaggerc-production.up.railway.app">Railway (produção)</option>
                  <option value="http://localhost:7111">Localhost :7111</option>
                  <option value="__custom">Personalizado…</option>
                </select>
              </div>
              <div class="col">
                <input id="customBase" class="form-control form-control-sm" placeholder="https://minha-api..." style="display:none">
              </div>
              <div class="col-auto">
                <button id="saveEnv" class="btn btn-sm btn-primary">Usar</button>
              </div>
            </div>
            <div class="mt-2 small text-muted monospace">
              Base atual: <span id="apiBase">—</span>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Alertas -->
    <div id="alertBox" class="alert alert-danger d-none" role="alert"></div>

    <div class="row g-4">
      <!-- Formulário de Adicionais -->
      <div class="col-12 col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title mb-3">Gerenciar Adicionais</h5>

            <!-- Um único form para Criar/Editar -->
            <form id="formAdicional" class="stack-sm">
              <input type="hidden" id="adicionalId">
              <div>
                <label for="nome" class="form-label">Nome</label>
                <input id="nome" class="form-control" placeholder="Ex.: Bacon" maxlength="60" required />
              </div>
              <div>
                <label for="preco" class="form-label">Preço (R$)</label>
                <input id="preco" class="form-control" type="number" min="0" step="0.01" placeholder="Ex.: 3.50" required />
              </div>
              <div class="form-check">
                <input id="ativo" class="form-check-input" type="checkbox" checked />
                <label class="form-check-label" for="ativo">Disponível para venda</label>
              </div>

              <div class="d-grid gap-2 d-sm-flex">
                <button class="btn btn-success" id="btnSalvar" type="submit">+ Criar adicional</button>
                <button class="btn btn-outline-secondary" id="btnLimpar" type="button">Limpar</button>
              </div>
            </form>

            <hr class="my-4">

            <div class="d-flex justify-content-between align-items-center">
              <div class="form-check">
                <input id="filtroAtivos" class="form-check-input" type="checkbox">
                <label for="filtroAtivos" class="form-check-label">Mostrar apenas ativos</label>
              </div>
              <button class="btn btn-sm btn-outline-secondary" id="btnRecarregar">Recarregar</button>
            </div>

          </div>
        </div>
      </div>

      <!-- Lista de Adicionais -->
      <div class="col-12 col-lg-8">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title mb-3">Lista de Adicionais</h5>

            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 80px;">#</th>
                    <th>Nome</th>
                    <th style="width: 160px;">Preço</th>
                    <th style="width: 120px;">Ativo</th>
                    <th style="width: 170px;">Ações</th>
                  </tr>
                </thead>
                <tbody id="tbodyAdicionais">
                  <!-- Linhas renderizadas via JS -->
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </div>

    <footer class="text-center text-muted mt-4 small">
      Dica: use o seletor de ambiente para alternar entre o <strong>Railway</strong> e o <strong>localhost:7111</strong>.
    </footer>
  </div>

  <!-- Toast simples -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Pronto!</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script>
    // =============== Configuração de Ambiente ===============
    const LS_KEY = "burger_api_base";
    const envSelect   = document.getElementById("envSelect");
    const customInput = document.getElementById("customBase");
    const saveEnvBtn  = document.getElementById("saveEnv");
    const apiBaseSpan = document.getElementById("apiBase");

    function getBase() {
      const v = localStorage.getItem(LS_KEY);
      return v || "https://swaggerc-production.up.railway.app";
    }
    function setBase(v) {
      localStorage.setItem(LS_KEY, v);
      apiBaseSpan.textContent = v;
    }
    function initEnvUI() {
      const current = getBase();
      apiBaseSpan.textContent = current;

      if (current === "http://localhost:7111") {
        envSelect.value = "http://localhost:7111";
        customInput.style.display = "none";
      } else if (current === "https://swaggerc-production.up.railway.app") {
        envSelect.value = "https://swaggerc-production.up.railway.app";
        customInput.style.display = "none";
      } else {
        envSelect.value = "__custom";
        customInput.style.display = "block";
        customInput.value = current;
      }
    }
    envSelect.addEventListener("change", () => {
      customInput.style.display = envSelect.value === "__custom" ? "block" : "none";
    });
    saveEnvBtn.addEventListener("click", () => {
      const val = envSelect.value === "__custom" ? customInput.value.trim() : envSelect.value;
      if (!val) return showAlert("Informe a URL base da API.");
      setBase(val);
      showToast("Ambiente atualizado.");
      carregarAdicionais();
    });

    // =============== Helpers UI/HTTP ===============
    const alertBox = document.getElementById("alertBox");
    function showAlert(msg) {
      alertBox.textContent = msg;
      alertBox.classList.remove("d-none");
      setTimeout(() => alertBox.classList.add("d-none"), 5000);
    }
    function showToast(msg) {
      document.getElementById("toastBody").textContent = msg;
      const t = bootstrap.Toast.getOrCreateInstance(document.getElementById("toast"));
      t.show();
    }

    async function api(path, options = {}) {
      const BASE = getBase().replace(/\/+$/, "");
      const url  = `${BASE}${path}`;
      try {
        const res = await fetch(url, {
          headers: { "Content-Type": "application/json" },
          mode: "cors",
          ...options
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`HTTP ${res.status} — ${text || res.statusText}`);
        }
        const ct = res.headers.get("content-type") || "";
        return ct.includes("application/json") ? res.json() : res.text();
      } catch (err) {
        const hint = err.message.includes("Failed to fetch")
          ? " Falha de rede/CORS. Confirme se a API está rodando e se o CORS está habilitado."
          : "";
        showAlert(err.message + hint);
        throw err;
      }
    }

    function brl(v) { return Number(v).toLocaleString("pt-BR", { style: "currency", currency: "BRL" }); }

    // =============== CRUD Adicionais ===============
    const tbody = document.getElementById("tbodyAdicionais");
    const form  = document.getElementById("formAdicional");
    const btnSalvar = document.getElementById("btnSalvar");
    const btnLimpar = document.getElementById("btnLimpar");
    const filtroAtivos = document.getElementById("filtroAtivos");
    const btnRecarregar = document.getElementById("btnRecarregar");

    function getFormData() {
      return {
        id: Number(document.getElementById("adicionalId").value || 0),
        nome: document.getElementById("nome").value.trim(),
        preco: Number(document.getElementById("preco").value),
        ativo: document.getElementById("ativo").checked
      };
    }
    function setFormData(a = null) {
      document.getElementById("adicionalId").value = a?.id || "";
      document.getElementById("nome").value = a?.nome || "";
      document.getElementById("preco").value = a?.preco != null ? a.preco : "";
      document.getElementById("ativo").checked = a?.ativo ?? true;
      btnSalvar.textContent = a ? "Salvar alterações" : "+ Criar adicional";
    }

    async function carregarAdicionais() {
      const only = filtroAtivos.checked ? "?somenteAtivos=true" : "";
      const itens = await api(`/api/adicionais${only}`);
      renderTabela(itens);
    }

    function renderTabela(itens) {
      tbody.innerHTML = "";
      itens.forEach(a => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="text-muted">#${a.id}</td>
          <td class="fw-medium">${a.nome}</td>
          <td>${brl(a.preco)}</td>
          <td>
            ${a.ativo
              ? '<span class="badge text-bg-success">Ativo</span>'
              : '<span class="badge text-bg-secondary">Inativo</span>'}
          </td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-outline-primary me-1" data-edit>Editar</button>
            <button class="btn btn-sm btn-outline-danger" data-del>Excluir</button>
          </td>
        `;

        tr.querySelector("[data-edit]").onclick = () => {
          setFormData(a);
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        tr.querySelector("[data-del]").onclick = async () => {
          if (!confirm(`Excluir adicional #${a.id}?`)) return;
          await api(`/api/adicionais/${a.id}`, { method: "DELETE" });
          showToast("Adicional excluído.");
          carregarAdicionais();
          if (Number(document.getElementById("adicionalId").value) === a.id) setFormData(null);
        };

        tbody.appendChild(tr);
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = getFormData();
      if (!data.nome) return showAlert("Informe o nome.");
      if (isNaN(data.preco)) return showAlert("Informe um preço válido.");

      if (data.id) {
        await api(`/api/adicionais/${data.id}`, {
          method: "PUT",
          body: JSON.stringify(data)
        });
        showToast("Adicional atualizado.");
      } else {
        const payload = { nome: data.nome, preco: data.preco, ativo: data.ativo };
        await api(`/api/adicionais`, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        showToast("Adicional criado.");
      }
      setFormData(null);
      carregarAdicionais();
    });

    btnLimpar.addEventListener("click", () => setFormData(null));
    filtroAtivos.addEventListener("change", carregarAdicionais);
    btnRecarregar.addEventListener("click", carregarAdicionais);

    // =============== Inicialização ===============
    initEnvUI();
    setFormData(null);
    carregarAdicionais();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
